# 东南大学统一身份认证系统微信接入小程序

## 项目目标

提供微信小程序/微信公众号应用与东南大学统一身份认证系统接入的解决方案。

适用场景：需要验证身份，保证仅向在校师生/教职员工开放的应用。


## 微信公众号接入统一身份认证

认证流程实现需要接入微信公众平台开发，您的业务服务器应具有以下功能：

    - 事件推送/消息推送/自定义菜单事件推送 （一种或多种）
    - 客服接口 （满足推送小程序卡片的要求）

认证结果通过 HTTP/HTTPS 请求推送至业务服务器，也必须实现相应的API接口以保证流程实现。

### 接入申请

请向管理部门登记您需要接入统一身份认证的应用信息，包含：

    - 应用名称 （将向用户展示）
    - 应用介绍（200字以内）（将向用户展示）
    - APPID
    - 认证成功消息推送地址

### 认证流程

此处描述的认证流程是 **推荐** 的方案，仅供参考，也可能存在其他实现方式。

1. **用户触发 事件推送/消息推送/自定义菜单事件推送 中包含的事件**

常见入口有：用户关注公众号、用户发送消息、用户点击菜单

产生到业务服务器的消息推送

2. **业务服务器通过客服消息发送小程序卡片**

业务服务器响应来自微信服务器的消息推送，从中获取用户OPENID。业务服务器 **自行** 生成和 OPENID 具有 **对应关系** 的 IDS_SESSION ，并合理持久化以备查询。

业务服务器调用客服接口发送小程序卡片，具体方法参见：https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140547

**消息模板**

```
{
    "touser":"OPENID", // 用户的OPENID
    "msgtype":"miniprogrampage",
    "miniprogrampage":
    {
        "title":"东南大学统一身份认证登录", // 名称可自定义，应对用户操作起到引导、解释作用
        "appid":"wxaef6d2413690047f", // 统一身份认证小程序APPID
        "pagepath":"pages/idsAuth?APPID=<APPID>&IDS_SESSION=<IDS_SESSION>&FORCE=<FORCE>", // 指定参数
        "thumb_media_id":"thumb_media_id"
    }
}
```

**参数解释**

    - APPID ：应用APPID

    - IDS_SESSION ：由业务服务器生成和用户身份对应的字符串

    - FORCE ：
        - FORCE=1 ：强制重新登录，禁用认证小程序快速授权功能，适用于对安全性要求较高的场合
        - FORCE=0 ：允许快速授权，此时若用户在认证小程序存在记录则可直接复用该信息

3. **用户操作小程序完成认证（此部分在小程序中实现，用户无需关心其具体流程）**

4. **认证成功消息推送**

**⚠️注意** 认证不成功不会推送任何消息，请妥善设计您的业务逻辑

用户完成小程序中包含的认证流程，小程序将向业务服务器推送认证成功消息。

此消息推送利用微信小程序云环境发起，需要保证您登记的业务服务器可以被公网访问，否则无法接受推送。

假设登记认证成功消息推送地址为：https://example.server/idsCallback

小程序将向其发起 POST 请求，请求body为JSON格式，具体如下：

```
{
    "ids_session":<调起小程序时传入的参数>,
    "name":<统一身份认证系统中记录的姓名>,
    "cardnum":<统一身份认证系统使用的一卡通号>,
    "identity":<"本科生"|"研究生"|"教职员工"> // 通过一卡通号格式判断，也可自行通过一卡通号判断
}
```

业务服务器在接受认证成功推送请求后，若逻辑判断认证成功则在响应body中 **包含** "success" 字符串，否则视为失败。认证小程序将根据此结果向用户提供交互提示。

上述响应应在5秒之内完成（无论响应成功或者失败），对于超时的情况，小程序将发起重试。重试进行3次，如果始终无法接受到有效响应则向用户提示认证失败。

