# 东南大学统一身份认证系统微信接入小程序

## 应用场景

提供微信小程序/微信公众号应用与东南大学统一身份认证系统接入的解决方案。

适用场景：需要验证用户的东南大学在校生/教职员工身份，保证功能仅向在东南大学校师生/教职员工开放的微信小程序/公众号应用。

-----

**下面介绍微信公众号/微信小程序接入统一身份认证的方法案例**

-------


## 微信公众号接入统一身份认证

认证流程实现需要接入微信公众平台开发，您的业务服务器应具有以下功能：

    - 事件推送/消息推送/自定义菜单事件推送 （一种或多种）
    - 客服接口 （满足推送小程序卡片的要求）

认证结果通过 HTTP/HTTPS 请求推送至业务服务器，也必须**实现相应的API接口**以保证流程实现。

### 接入申请

请向管理部门登记您需要接入统一身份认证的应用信息，包含：

    - 应用名称 （将向用户展示）
    - 应用介绍（200字以内）（将向用户展示）
    - APPID
    - 自定义的Secret（将用来生成签名）
    - 认证成功消息推送地址

### 关联小程序

根据微信公众平台要求，下发小程序卡片或文字链需要设置公众号关联本微信小程序。

### 认证流程

⚠️ 此处描述的认证流程是 **推荐** 的方案，仅供参考，也可能存在其他实现方式。

1. **用户触发 事件推送/消息推送/自定义菜单事件推送 中包含的事件**

   常见入口有：用户关注公众号、用户发送消息、用户点击菜单等，微信服务器产生到业务服务器的消息推送。该步骤的根本目的是获取用户的OpenID以实现用户身份鉴别。

2. **业务服务器通过客服消息发送小程序文字链/小程序卡片**

   业务服务器接收来自微信服务器的消息推送，从中获取用户 OpenID。业务服务器 **自行** 生成和 OpenID 具有 **对应关系** 的 IDS_SESSION ，并**持久化**以备查询。

   **⭐️方式一：**业务服务器调用客服接口发送小程序卡片，具体方法参见：https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140547

    **消息模板**

    ```json
    {
        "touser":"OpenID", // 用户的OPENID
        "msgtype":"miniprogrampage",
        "miniprogrampage":
        {
            "title":"东南大学统一身份认证登录", // 名称可自定义，应对用户操作起到引导、解释作用
            "appid":"wxaef6d2413690047f", // 统一身份认证小程序APPID
            "pagepath":"pages/idsAuth?APPID=<APPID>&IDS_SESSION=<IDS_SESSION>&FORCE=<FORCE>", // 指定参数
            "thumb_media_id":"thumb_media_id" // thumb_media_id获取方式较为繁琐，请参考文档
        }
    }
    ```

    **⭐️方式二：** 业务服务器调用客服接口发送小程序文字链，具体方法参见：https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140547

    **消息模板**

    ```json
    {
        "touser": "OpenID", // 用户的OPENID
        "msgtype": "text",
        "text":
        {
            "content": "<a href="https://myseu.cn" data-miniprogram-appid="wxaef6d2413690047f" data-miniprogram-path="pages/idsAuth?APPID=<APPID>&IDS_SESSION=<IDS_SESSION>&FORCE=<FORCE>">统一身份认证登录</a>"
        }
    }
    ```

    **🎛参数解释**
    ```
    - APPID ：应用APPID

    - IDS_SESSION ：由业务服务器生成和用户身份对应的字符串

    - FORCE ：
        - FORCE=1 ：强制重新登录，禁用认证小程序快速授权功能，适用于对安全性要求较高的场合
        - FORCE=0 ：允许快速授权，此时若用户在认证小程序存在记录则可直接复用该信息
    ```

3. **用户操作小程序完成认证（此部分在小程序中实现，无需关心其具体流程）**

4. **认证成功消息推送**

   **⚠️注意** 认证不成功不会推送任何消息，请妥善设计您的业务逻辑

   用户完成小程序中包含的认证流程，IDS小程序将向业务服务器推送认证成功消息。

   此消息推送利用微信小程序云环境发起，需要保证您登记的**业务服务器**可以被**公网访问**，否则无法接受推送。

   假设登记认证成功消息推送地址为：https://example.server/idsCallback

   IDS小程序将向其发起 POST 请求，请求body为JSON格式，具体如下：

    ```
    {
        "ids_session":<调起小程序时传入的参数>,
        "name":<统一身份认证系统中记录的姓名>,
        "cardnum":<统一身份认证系统使用的一卡通号>,
        "identity":<"本科生"|"研究生"|"教职员工"> // 通过一卡通号格式判断，也可自行通过一卡通号判断,
        "challenge":<由小程序生成的随机字符串>,
        "signature":<由小程序生成的签名，用于验证请求是否来自统一身份认证小程序>
    }
    ```

    **签名生成算法**

    ```
      // 拼接原始字符串
      let string1 = `cardnum=${cardnum}&name=${name}&session=${ids_session}&challenge=${challenge}&secret=${secret}`
      // 计算 sha1 摘要
      let signature = sha1(string1)
    ```

    业务服务器在接受认证成功推送请求后，若逻辑判断认证成功则在响应body中 **包含** "success" 字符串，否则视为失败。认证小程序将根据此结果向用户提供交互提示。

    上述响应应在5秒之内完成（无论响应成功或者失败），对于超时的情况，小程序将发起重试。重试进行3次，如果始终无法接受到有效响应则向用户提示认证失败。

## 微信小程序接入统一身份认证

微信小程序认证过程相较于微信公众号认证更为简单，主要通过小程序跳转实现。

### 接入申请

请向管理部门登记您需要接入统一身份认证的应用信息，包含：

```
- 应用名称 （将向用户展示）
- 应用介绍（200字以内）（将向用户展示）
- APPID
- 认证成功消息推送地址
```

### 关联小程序

根据微信公众平台要求，微信小程序之间跳转需要设置待开发小程序关联IDS小程序。为便于区分，以下称待开发微信小程序为“第三方小程序”，称东南大学IDS登录小程序为IDS小程序。

### 认证流程

⚠️ 此处描述的认证流程是 **推荐** 的方案，仅供参考，也可能存在其他实现方式。

在完成接入申请和微信小程序关联后即可通过小程序跳转的方式实现统一身份认证接入：

1. **实现第三方小程序至IDS小程序跳转**

   使用`navigator`组件进行跳转，示例：

   ```xml
   <navigator target="miniProgram" app-id="wxaef6d2413690047f" path="pages/index" extra-data="{{{force:<FORCE>}}}">统一身份认证</navigator>
   ```

   **🎛参数解释**

   ```
   - FORCE ：
       - FORCE=1 ：强制重新登录，禁用IDS小程序快速授权功能，适用于对安全性要求较高的场合
       - FORCE=0 ：允许快速授权，此时若用户在IDS小程序存在记录则可直接复用该信息
   ```

2. **在第三方小程序中获取认证信息**

   请在小程序的 `onShow(obj)` 生命周期方法中拦截场景值为**1038**的进入场景。

   IDS小程序通过 `wx.navigateBackMiniProgram(Object object)` 方法返回第三方小程序，在extraData字段放置认证信息，结构如下：

   ```
   {
       name:<用户真实姓名>, 
       cardnum:<用户一卡通号码>, 
       identity:<'本科生'|'研究生'|'教职员工'>
   }
   ```

   如需具体获取方法，请参阅：https://developers.weixin.qq.com/miniprogram/dev/api/wx.onAppShow.html。

   **⚠️注意** 若extraData字段不包含以上信息，可能是用户通过导航栏返回键等功能放弃认证过程返回，可视为认证无效。请妥善设计程序逻辑保证信息安全。

 